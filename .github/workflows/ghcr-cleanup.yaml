name: Cleanup Old Images

on:
    schedule:
        # Monthly at midnight UTC
        - cron: "0 0 1 * *"
    workflow_dispatch: # Allow manual trigger
    workflow_run:
        workflows: ["Release Helm Chart"]
        types:
            - completed

permissions:
    packages: write

env:
    KEEP_HASH_TAGS: 2
    KEEP_RELEASE_TAGS: 5

jobs:
    cleanup:
        runs-on: ubuntu-latest
        steps:
            - name: Login to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Get all package versions
              id: get_versions
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const owner = context.repo.owner;
                      const packageName = 'app-template';

                      // Get all versions of the package
                      let allVersions = [];
                      let page = 1;

                      while (true) {
                        const response = await github.rest.packages.getAllPackageVersionsForPackageOwnedByUser({
                          package_type: 'container',
                          package_name: packageName,
                          username: owner,
                          per_page: 100,
                          page: page
                        });
                        
                        if (response.data.length === 0) break;
                        allVersions = allVersions.concat(response.data);
                        page++;
                      }

                      console.log(`Found ${allVersions.length} total versions`);

                      // Separate hash tags (v<7-char-hex>) from release tags (vX.X.X)
                      const hashTagPattern = /^v[0-9a-f]{7}$/;
                      const releaseTagPattern = /^v\d+\.\d+\.\d+/;

                      const hashVersions = [];
                      const releaseVersions = [];

                      for (const version of allVersions) {
                        const tags = version.metadata?.container?.tags || [];
                        const mainTag = tags[0] || '';
                        
                        if (hashTagPattern.test(mainTag)) {
                          hashVersions.push({
                            id: version.id,
                            tag: mainTag,
                            created_at: version.created_at
                          });
                        } else if (releaseTagPattern.test(mainTag)) {
                          releaseVersions.push({
                            id: version.id,
                            tag: mainTag,
                            created_at: version.created_at
                          });
                        }
                      }

                      // Sort by creation date (newest first)
                      hashVersions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                      releaseVersions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                      console.log(`Found ${hashVersions.length} hash-tagged versions`);
                      console.log(`Found ${releaseVersions.length} release versions`);

                      // Determine which to delete
                      const keepHashTags = parseInt(process.env.KEEP_HASH_TAGS);
                      const keepReleaseTags = parseInt(process.env.KEEP_RELEASE_TAGS);

                      const hashToDelete = hashVersions.slice(keepHashTags);
                      const releaseToDelete = releaseVersions.slice(keepReleaseTags);

                      console.log(`Will delete ${hashToDelete.length} hash versions (keeping ${keepHashTags})`);
                      console.log(`Will delete ${releaseToDelete.length} release versions (keeping ${keepReleaseTags})`);

                      // Return IDs to delete
                      const toDelete = [...hashToDelete, ...releaseToDelete];

                      return {
                        toDelete: toDelete,
                        summary: {
                          totalFound: allVersions.length,
                          hashFound: hashVersions.length,
                          releaseFound: releaseVersions.length,
                          hashDeleting: hashToDelete.length,
                          releaseDeleting: releaseToDelete.length
                        }
                      };

            - name: Delete old versions
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const result = ${{ steps.get_versions.outputs.result }};
                      const owner = context.repo.owner;
                      const packageName = 'app-template';

                      console.log('Summary:');
                      console.log(`  Total versions found: ${result.summary.totalFound}`);
                      console.log(`  Hash versions: ${result.summary.hashFound} (deleting ${result.summary.hashDeleting})`);
                      console.log(`  Release versions: ${result.summary.releaseFound} (deleting ${result.summary.releaseDeleting})`);
                      console.log('');

                      if (result.toDelete.length === 0) {
                        console.log('Nothing to delete!');
                        return;
                      }

                      console.log('Deleting old versions...');

                      for (const version of result.toDelete) {
                        try {
                          await github.rest.packages.deletePackageVersionForUser({
                            package_type: 'container',
                            package_name: packageName,
                            username: owner,
                            package_version_id: version.id
                          });
                          console.log(`  Deleted: ${version.tag} (created: ${version.created_at})`);
                        } catch (error) {
                          console.log(`  Failed to delete ${version.tag}: ${error.message}`);
                        }
                      }

                      console.log('Cleanup complete!');
