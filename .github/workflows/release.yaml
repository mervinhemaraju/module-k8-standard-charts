name: Release Helm Chart

on:
  pull_request:
    types:
      - opened
      - synchronize # Triggers on new commits pushed to PR
      - closed
    branches:
      - main

permissions:
  contents: write
  packages: write

jobs:
  # Runs on every push to an open PR from release/* branches - creates commit-based pre-release
  pre-release:
    if: |
      github.event.action != 'closed' &&
      startsWith(github.event.pull_request.head.ref, 'release/v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version info
        id: version
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          COMMIT_SHA="${{ github.event.pull_request.head.sha }}"
          SHORT_SHA="${COMMIT_SHA::7}"

          echo "Branch: $BRANCH"
          echo "Commit SHA: $SHORT_SHA"

          # Extract version from branch name (release/v0.1.0 -> 0.1.0)
          if [[ "$BRANCH" =~ ^release/v(.+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            echo "Branch does not match expected pattern: release/vX.X.X"
            exit 1
          fi

          TAG="v${VERSION}-${SHORT_SHA}"
          PACKAGE_VERSION="${VERSION}-${SHORT_SHA}"

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "commit_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT

          echo "Tag: $TAG"
          echo "Package Version: $PACKAGE_VERSION"

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Lint Helm Chart
        run: helm lint .

      - name: Package Helm Chart
        run: |
          helm package . --destination .helm-packages --version "${{ steps.version.outputs.package_version }}"
          ls -la .helm-packages/

      - name: Create GitHub Pre-Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          prerelease: true
          body: |
            ## Pre-release ${{ steps.version.outputs.tag }}

            **Commit:** ${{ github.event.pull_request.head.sha }}
            **Branch:** ${{ github.event.pull_request.head.ref }}
            **PR:** #${{ github.event.pull_request.number }}

            This is an automated pre-release build from a release branch.

          files: |
            .helm-packages/*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push to GHCR as OCI artifact
        run: |
          helm push .helm-packages/*.tgz oci://ghcr.io/${{ github.repository_owner }}

  # Runs when release/* PR is merged to main - creates final release
  release:
    if: |
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'release/v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from branch name
        id: version
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          echo "Branch: $BRANCH"

          if [[ "$BRANCH" =~ ^release/v(.+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
            TAG="v${VERSION}"
          else
            echo "Branch does not match expected pattern: release/vX.X.X"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          echo "Version: $VERSION"
          echo "Tag: $TAG"

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      # - name: Update Chart.yaml version
      #   run: |
      #     sed -i "s/^version: .*/version: ${{ steps.version.outputs.version }}/" Chart.yaml
      #     cat Chart.yaml

      # - name: Commit version update
      #   run: |
      #     git add Chart.yaml
      #     git commit -m "chore: update version to ${{ steps.version.outputs.version }}" || echo "No changes to commit"
      #     git push

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Lint Helm Chart
        run: helm lint .

      - name: Package Helm Chart
        run: |
          helm package . --destination .helm-packages
          ls -la .helm-packages/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          body: |
            ## Helm Chart ${{ steps.version.outputs.tag }}

            ### Installation

            ```bash
            helm install my-app oci://ghcr.io/${{ github.repository_owner }}/app-template \
              --version ${{ steps.version.outputs.version }} \
              -f values.yaml
            ```

          files: |
            .helm-packages/*.tgz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push to GHCR as OCI artifact
        run: |
          helm push .helm-packages/*.tgz oci://ghcr.io/${{ github.repository_owner }}
